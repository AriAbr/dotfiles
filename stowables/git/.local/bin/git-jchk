#!/usr/bin/env bash

#==================================================
# SETUP DEBUGGING AND SAFETY FLAGS
#==================================================
set -o errexit  # exit script on error
set -o pipefail # exit when a script in a pipeline fails
set -o nounset  # don't allow unset variables

if [[ $(git status --porcelain=v1 2>/dev/null | wc -l) -gt 0 ]]; then
	echo "You have unstaged changes. Exiting."
	echo ""
	git status
	exit 1
fi

git fetch --all >/dev/null

OLD_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Checkout branch
(
	rollcheck "$1"
) || (
	rollcheck master
	git reset --hard origin/master
	rollcheck -b "$1" && git push -u origin "$1"
)

NEW_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# FIX: Needs to be generalized to check for yarn too, and also not to break in
# repos that don't have either of them
# Check for changes in poetry lock file
# POETRY_LOCK_DIFF=$(git diff $NEW_BRANCH $OLD_BRANCH -- poetry.lock)
# if [[ -n $POETRY_LOCK_DIFF ]]; then
# 	echo $'\nPOETRY CHANGES FOUND: Run `dm poetry install` to update your packages'
# fi

# FIX: This doesn't work right now
# remove test databases for new branch
# dm test clean
